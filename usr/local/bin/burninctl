#!/usr/bin/env bash

# progress bar https://github.com/fearside/ProgressBar/blob/master/progressbar.sh
function ProgressBar {
# Process data
	let _done=${1}*4/10
	let _left=50-$_done
# Build progressbar string lengths
	_done=$(printf "%${_done}s")
	_left=$(printf "%${_left}s")

# 1.2 Build progressbar strings and print the ProgressBar line
# 1.2.1 Output example:
# 1.2.1.1 Progress : [########################################] 100%
printf "\rProgress : [${_done// /#}${_left// /-}] ${1}%%"

}

# estimated pogress bar value, based on estimate time to complete every test: i want an unuseful progress bar :-)
function bar {
  lines=$( cat "${working_dir}/${1}" | wc -l)
  case $lines in
    1|2|3|4|5|6|7|8|9) ProgressBar 5 ;;
    10) ProgressBar 15 ;;
    11) ProgressBar 32 ;;
    12) ProgressBar 50 ;;
    13) ProgressBar 68 ;;
    14) ProgressBar 85 ;;
    15) ProgressBar 95 ;;
  esac
}

# get the path to store report file, log and "run"
working_dir="$(cat /etc/burnin)"

while :
do
  printf "\033c"
  process=($(systemctl list-units --all --state=active | grep burnin | grep running | awk '{print $1}'))
  if [ ${#process[@]} -eq 0 ]; then
    echo "No running test"
    echo
    read -rsp $'Press enter to refresh...\n'
  else
    echo
    echo "Burnin HDD control"
    echo
    i=0
    for service in ${process[*]}
    do
      device[$i]="/dev/"$(echo  "$service" | sed 's/.*@\(.*\)\..*/\1/')
      sn=$(smartctl -i "${device[$i]}" | grep "Serial Number" | cut -d ":" -f 2 | sed -e 's/^[ \t]*//')
      since=$(systemctl status "$service" | grep "active (running)" | cut -d ")" -f 2 | sed -e 's/^[ \t]*//')
      echo "#$i ${device[i]} - ${sn} is running ${since}"
      bar "${sn}"
      pid[$i]=$(systemctl status "$service" | grep "Main PID" | awk '{print $3}')
      i=$((i+1))
    done
    echo
    echo
    # echo "Press Enter to refresh, or insert the number of the the device to show the log [1-6]: " 
    read -t 10 -p $'Press Enter to refresh, or insert the number of the the device to show the log [1-6]: ' num
    if [ "$i" -gt "$num" ] && [ "$num" -ge 0 ]; then
      printf "\033c"
      journalctl _PID="${pid[$num]}" -e -o json | jq -M -r '"\(.__REALTIME_TIMESTAMP | tonumber / 1000000) \(.MESSAGE)"' | awk '{ $1=strftime("%b %d %T", $1); print $0; fflush(); }' | less
      read -rsp $'Press enter to continue...\n'
    fi
  fi
done
